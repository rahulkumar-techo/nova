name: ğŸš€ Next.js CI/CD (NoteMentor)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: ğŸ—ï¸ Build and Test
    runs-on: ubuntu-latest

    steps:
      # ğŸ§° Step 1: Checkout repository
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      # âš™ï¸ Step 2: Setup Node.js with caching
      - name: ğŸ§© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # âš¡ Step 3: Cache Next.js build (improves rebuild times)
      - name: âš¡ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules/.cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            nextjs-${{ runner.os }}-

      # ğŸ“¦ Step 4: Install dependencies
      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # ğŸ§¹ Step 5: Lint (optional)
      - name: ğŸ” Run ESLint
        run: npm run lint --if-present

      # ğŸ” Step 6: Build project with environment variables
      - name: ğŸ—ï¸ Build Next.js project
        run: npm run build
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_SECRET_ID: ${{ secrets.GOOGLE_SECRET_ID }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

      # âœ… Step 7: Run tests (optional)
      - name: ğŸ§ª Run tests
        run: npm test --if-present

      # ğŸ“¤ Step 8: Upload production build (optional)
      - name: ğŸ“¦ Upload .next build output
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: .next

  # ğŸ”” Notification Job
  notify:
    name: ğŸ”” Telegram Notification
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ’¬ Send Telegram Notification
        run: |
          MESSAGE="ğŸš€ *NoteMentor CI/CD*%0AStatus: *${{ job.status }}*%0ABranch: \`${{ github.ref_name }}\`%0ACommit: \`${{ github.sha }}\`%0ABy: *${{ github.actor }}*%0AğŸ”— [View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d parse_mode="Markdown" \
          -d text="$MESSAGE"
